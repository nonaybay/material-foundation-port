@use 'sass:color';
@use 'sass:math';
@use 'math' as lmath;
@use '../../glob/constants/color' as *;



@function get-r($c) {
  @return color.red($c);
}

@function get-g($c) {
  @return color.green($c);
}

@function get-b($c) {
  @return color.blue($c);
}

@function linearized($x) {
  $n: math.div($x, $MAX_RGB);

  @if ($n <=$BETADELTA) {
    @return (math.div($n, $DELTA) * 100);
  } @else {
    @return (math.pow(math.div(($n + $MIN_ALPHA), $MAX_ALPHA), $MAX_GAMMA) * 100);
  }
}

@function delinearized($x) {
  $n: math.div($x, 100);
  $d: 0;

  @if ($n <= $BETA) {
    $d: ($n * $DELTA);
  } @else {
    $d: ($MAX_GAMMA * math.pow($n, math.div($INT, $MAX_GAMMA)) - $MIN_GAMMA);
  }

  @return math.clamp(0, ($d * $MAX_RGB), $MAX_RGB);
}

@function lab-f($t) {
  $e: math.div(216, 24389);
  $k: math.div(24389, 27);

  @if ($t > $e) {
    @return math.pow($t, math.div(1, 3));
  } @else {
    @return math.div(($k * $t + 16), 116);
  }
}

@function lab-f-inv($ft) {
  $e: math.div(216, 24389);
  $k: math.div(24389, 27);
  $ft3: math.pow($ft, 3);

  @if ($ft3 > $e) {
    @return $ft3;
  } @else {
    @return math.div((116 * $ft - 16), $k);
  }
}

@function xyz-from-rgb($rgb) {
  $r: linearized(get-r($rgb));
  $g: linearized(get-g($rgb));
  $b: linearized(get-b($rgb));
  $m: (($r, $g, $b,),);

  @return lmath.matrix-multiply($m, $SRGB_XYZ);
}

@function lab-from-rgb($rgb) {
  $lr: linearized(get-r($rgb));
  $lg: linearized(get-g($rgb));
  $lb: linearized(get-b($rgb));
  $m: $SRGB_XYZ;

  $x: lmath.gm($m, 1, 1) * $lr + lmath.gm($m, 1, 2) * $lg + lmath.gm($m, 1, 3) * $lb;
  $y: lmath.gm($m, 2, 1) * $lr + lmath.gm($m, 2, 2) * $lg + lmath.gm($m, 2, 3) * $lb;
  $z: lmath.gm($m, 3, 1) * $lr + lmath.gm($m, 3, 2) * $lg + lmath.gm($m, 3, 3) * $lb;

  $wp: $WP_D65;

  $xn: math.div($x, lmath.gm($wp, 1, 1));
  $yn: math.div($y, lmath.gm($wp, 1, 2));
  $zn: math.div($z, lmath.gm($wp, 1, 3));

  $fx: lab-f($xn);
  $fy: lab-f($yn);
  $fz: lab-f($zn);

  $LABl: (116 * $fy - 16);
  $LABa: (500 * ($fx - $fy));
  $LABb: (200 * ($fy - $fz));

  $lab-as-matrix: ( ($l, $a, $b, ), );

  @return $lab-as-matrix;
}

@function lstar-from-rgb($rgb) {
  $y: lmath.gm(xyz-from-rgb($rgb), 1, 2);

  @return (116 * lab-f(math.div($y, 100)) - 16);
}

@function rgb-from-xyz($xyz) {
  $x: lmath.gm($xyz, 1);
  $y: lmath.gm($xyz, 2);
  $z: lmath.gm($xyz, 3);
  $m: $XYZ_SRGB;
  $lr: lmath.gm($m, 1, 1) * $x + lmath.gm($m, 1, 2) * $y + lmath.gm($m, 1, 3) * $z;
  $lg: lmath.gm($m, 2, 1) * $x + lmath.gm($m, 2, 2) * $y + lmath.gm($m, 2, 3) * $z;
  $lb: lmath.gm($m, 3, 1) * $x + lmath.gm($m, 3, 2) * $y + lmath.gm($m, 3, 3) * $z;
  $r: delinearized($lr);
  $g: delinearized($lg);
  $b: delinearized($lb);

  @return color.change(black, $red: $r, $green: $g, $blue: $b);
}

@function rgb-from-lab($lab) {
  $labl: lmath.gm($lab, 1);
  $laba: lmath.gm($lab, 2);
  $labb: lmath.gm($lab, 3);
  $wp: $WP_D65;
  $fy: math.div(($labl + 16), 116);
  $fx: (math.div($a, 500) + $fy);
  $fz: ($fy - math.div($b, 200));
  $xn: lab-f-inv($fx);
  $yn: lab-f-inv($fy);
  $zn: lab-f-inv($fz);

  $x: ($xn * lmath.gm($wp, 1, 1));
  $y: ($yn * lmath.gm($wp, 1, 2));
  $z: ($zn * lmath.gm($wp, 1, 3));

  $xyz-as-matrix: ( ($x, $y, $z, ), );

  @return rgb-from-xyz($xyz-as-matrix);
}

@function Y-from-lstar($lstar) {
  @return (100 * lab-f-inv(math.div(($lstar + 16), 116)));
}

@function rgb-from-lstar($lstar) {
  $y: Y-from-lstar($lstar);
  $c: delinearized($y);

  @return color.change(black, $red: $c, $green: $c, $blue: $c);
}
